{% extends 'contracts/base.html' %}
{% block title %}Import Data{% endblock %}

{% block content %}

    <div class="container">
       

        <div class="upload-section">
            <form method="post" enctype="multipart/form-data" id="uploadForm">
                {% csrf_token %}
                <div class="file-input-wrapper">
                    <input type="file" name="data_file" id="pdfFile" class="file-input" accept=".pdf,.zip" required>
                    <label for="pdfFile" class="file-input-label">
                         Choose PDF File or Drag & Drop Here
                    </label>
                </div>
                <button type="submit" class="submit-btn">Extract Data</button>
            </form>
        </div>

        {% if error %}
        <div class="error">
            <strong>Error:</strong> {{ error }}
        </div>
        {% endif %}

        {% if parsed_data %}
                  
                      <div class="action-buttons">
                        <button class="action-btn save-btn"  id="saveToDbBtn" onclick="saveToDatabase()">
                            <i class="fas fa-save"></i>Save to Database
                        </button>
                      </div>
                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <p>Saving to database...</p>
                    </div>
                    <div id="statusMessage"></div>
                </div>

        <div class="results-section">
                           <div class="card">
                            
                            
                            <div class="card-body">
                                <div class="card-header">
                                 Extracted English Text</div>
                <div class="data-display" id="englishText">{{ english_text }}</div>
                                    
            </div>
                                </div>
            
            <div class="card">
                                            <div class="card-body">

                   <div class="card-header">
                                 Extracted English Text</div>
                
                <div class="data-display" id="parsedData">{{ parsed_data|safe }}</div>
                                            </div>
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        // Drag and drop functionality
        const fileInput = document.getElementById('pdfFile');
        const fileLabel = document.querySelector('.file-input-label');

        fileLabel.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileLabel.style.background = 'linear-gradient(45deg, #00d4aa, #00ff41)';
        });

        fileLabel.addEventListener('dragleave', (e) => {
            e.preventDefault();
            fileLabel.style.background = 'linear-gradient(45deg, #00ff41, #00d4aa)';
        });

        fileLabel.addEventListener('drop', (e) => {
            e.preventDefault();
            fileLabel.style.background = 'linear-gradient(45deg, #00ff41, #00d4aa)';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                fileLabel.textContent = `üìÑ ${files[0].name}`;
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                fileLabel.textContent = `üìÑ ${e.target.files[0].name}`;
            }
        });

        // Save to database functionality
        function saveToDatabase() {
            const saveBtn = document.getElementById('saveToDbBtn');
            const loading = document.getElementById('loading');
            const statusMessage = document.getElementById('statusMessage');
            
            // Disable button and show loading
            saveBtn.disabled = true;
            loading.style.display = 'block';
            statusMessage.innerHTML = '';
            
            // Prepare data for saving
            const data = {
                parsed_data: JSON.parse(document.getElementById('parsedData').textContent),
                english_text: document.getElementById('englishText').textContent
            };
            
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        
            fetch('/save-to-database/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    return response.json().then(err => {
                        console.error('Server error:', err);
                        throw new Error(err.message || `HTTP ${response.status}: ${response.statusText}`);
                    });
                }
            })
            .then(data => {
                loading.style.display = 'none';
                
                if (data.success) {
                    statusMessage.innerHTML = `
                        <div class="status-message status-success">
                            ‚úÖ ${data.message}
                        </div>
                    `;
                } else {
                    statusMessage.innerHTML = `
                        <div class="status-message status-error">
                            ‚ùå ${data.message}
                        </div>
                    `;
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                statusMessage.innerHTML = `
                    <div class="status-message status-error">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
            })
            .finally(() => {
                saveBtn.disabled = false;
            });
        }

        // Export to Excel functionality
        function exportToExcel() {
            const exportBtn = document.getElementById('exportExcelBtn');
            const loadingExcel = document.getElementById('loadingExcel');
            const excelStatusMessage = document.getElementById('excelStatusMessage');
            
            // Disable button and show loading
            exportBtn.disabled = true;
            loadingExcel.style.display = 'block';
            excelStatusMessage.innerHTML = '';
            
            // Prepare data for export
            const data = {
                parsed_data: JSON.parse(document.getElementById('parsedData').textContent),
                english_text: document.getElementById('englishText').textContent
            };
            
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
            console.log('CSRF Token:', csrfToken ? 'Found' : 'Not found');
            console.log('Data to export:', data);
            
            // Send AJAX request
            fetch('/pdf_record/export-excel/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    return response.json().then(err => {
                        console.error('Server error:', err);
                        throw new Error(err.message || `HTTP ${response.status}: ${response.statusText}`);
                    });
                }
            })
            .then(blob => {
                loadingExcel.style.display = 'none';
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `contract_data_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                excelStatusMessage.innerHTML = `
                    <div class="status-message status-success">
                        ‚úÖ Excel file downloaded successfully!
                    </div>
                `;
            })
            .catch(error => {
                console.error('Export error:', error);
                loadingExcel.style.display = 'none';
                excelStatusMessage.innerHTML = `
                    <div class="status-message status-error">
                        ‚ùå Error: ${error.message || 'Failed to export Excel file'}
                    </div>
                `;
            })
            .finally(() => {
                exportBtn.disabled = false;
            });
        }

        // View data details function
        function viewDataDetails() {
            // Store the parsed data in sessionStorage for the details page
            const parsedData = document.getElementById('parsedData').textContent;
            const englishText = document.getElementById('englishText').textContent;
            
            sessionStorage.setItem('parsedData', parsedData);
            sessionStorage.setItem('englishText', englishText);
            
            // Navigate to the details page
            window.location.href = '/pdf_record/data-details/';
        }

        // View all data table function
        function viewAllDataTable() {
            // Store the parsed data in sessionStorage for the all data table page
            const parsedData = document.getElementById('parsedData').textContent;
            const englishText = document.getElementById('englishText').textContent;
            
            sessionStorage.setItem('parsedData', parsedData);
            sessionStorage.setItem('englishText', englishText);
            
            // Navigate to the all data table page
            window.location.href = '/pdf_record/all-data-table/';
        }

        // Add some cyberpunk animations
        document.addEventListener('DOMContentLoaded', function() {
            // Add typing effect to header
            const header = document.querySelector('.header h1');
            const text = header.textContent;
            header.textContent = '';
            
            let i = 0;
            const typeWriter = () => {
                if (i < text.length) {
                    header.textContent += text.charAt(i);
                    i++;
                    setTimeout(typeWriter, 100);
                }
            };
            
            setTimeout(typeWriter, 500);
        });
    </script>

{% endblock %}
